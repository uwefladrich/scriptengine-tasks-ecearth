name: Install from source
on:
  workflow_call:
    inputs:
      python-version:
        required: true
        type: string

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - name: Setup Python
        uses: actions/setup-python@v2
        with:
          python-version: ${{python-version}}
      - name: Download and install conda
        run: |
          wget https://repo.continuum.io/miniconda/Miniconda3-latest-Linux-x86_64.sh -O miniconda.sh
          bash miniconda.sh -b -p $HOME/miniconda
          source "$HOME/miniconda/etc/profile.d/conda.sh"
          hash -r
          conda config --set always_yes yes --set changeps1 no
          conda config --add channels conda-forge
          conda update -q conda
      - name: Create environment and load dependencies that PyPI cannot find
        env:
          python-version: ${{python-version}}
        run: |
          conda create -n test-environment python=${{matrix.python-version}}
          conda activate test-environment
          conda env update -n test-environment --quiet --file conda_environment.yml
          conda install pip
          conda install -c conda-forge "iris>=3.1,!=3.2.0,!=3.2.0.post0"
      - name: Install package + remaining PyPI dependencies
        run: pip install .